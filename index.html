<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم گردونه شانس</title>
    <style>
        /* همه استایل‌های قبلی رو اینجا کپی کنید */
        body {
            font-family: Tahoma, sans-serif;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: #333;
        }
        .management-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        .btn:hover {
            background: #c0392b;
        }
        .qr-container {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 10px;
        }
        .stats {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .tab {
            display: none;
        }
        .tab.active {
            display: block;
        }
        .btn-success {
            background: #27ae60;
        }
        .btn-warning {
            background: #f39c12;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="margin-bottom: 20px;">
            <button class="btn" onclick="showTab('management')">مدیریت</button>
            <button class="btn" onclick="showTab('wheel')">گردونه شانس</button>
        </div>

        <div id="management" class="tab active">
            <h1>🎯 مدیریت گردونه شانس</h1>
            <p>QR کد یکبار مصرف برای تراکت فروشگاه</p>
            
            <div class="management-panel">
                <button class="btn" onclick="generateQR()">تولید QR کد جدید</button>
                
                <div class="qr-container">
                    <div id="qrCode"></div>
                    <div id="qrInfo"></div>
                </div>
                
                <div class="stats">
                    <h3>📊 آمار</h3>
                    <p>تعداد تولید شده: <span id="totalCount">0</span></p>
                    <p>تعداد استفاده شده: <span id="usedCount">0</span></p>
                </div>
            </div>
        </div>

        <div id="wheel" class="tab">
            <h1>🎯 گردونه شانس فروشگاه</h1>
            <p>برای دریافت تخفیف گردونه رو بچرخانید!</p>
            
            <div style="margin: 20px 0; padding: 20px; background: #ffebee; border-radius: 10px;">
                <p>⚠️ برای استفاده از گردونه، لطفاً QR کد رو از تب مدیریت اسکن کنید</p>
            </div>
        </div>
    </div>

    <script>
        // سیستم ساده‌تر برای تولید QR کد
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }

        class QRManager {
            constructor() {
                this.storageKey = 'wheelQRCodes';
                this.init();
            }

            init() {
                if (!localStorage.getItem(this.storageKey)) {
                    localStorage.setItem(this.storageKey, JSON.stringify({
                        qrcodes: {},
                        stats: { total: 0, used: 0 }
                    }));
                }
            }

            getData() {
                return JSON.parse(localStorage.getItem(this.storageKey));
            }

            saveData(data) {
                localStorage.setItem(this.storageKey, JSON.stringify(data));
            }

            generateQR() {
                const data = this.getData();
                const qrId = 'QR_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                
                data.qrcodes[qrId] = {
                    id: qrId,
                    used: false,
                    created: new Date().toLocaleString('fa-IR')
                };

                data.stats.total++;
                this.saveData(data);
                
                return qrId;
            }

            getStats() {
                return this.getData().stats;
            }
        }

        const qrManager = new QRManager();

        function generateQR() {
            const qrId = qrManager.generateQR();
            const currentUrl = window.location.href.split('?')[0];
            const qrUrl = currentUrl + '?qr=' + qrId;
            
            document.getElementById('qrCode').innerHTML = '';
            
            // استفاده از سرویس آنلاین Google برای تولید QR کد
            const googleQRUrl = `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encodeURIComponent(qrUrl)}&choe=UTF-8`;
            
            const img = document.createElement('img');
            img.src = googleQRUrl;
            img.width = 200;
            img.height = 200;
            img.alt = 'QR Code';
            img.style.border = '2px solid #333';
            img.style.borderRadius = '10px';
            
            document.getElementById('qrCode').appendChild(img);
            
            document.getElementById('qrInfo').innerHTML = `
                <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                    <p><strong>شناسه:</strong> ${qrId}</p>
                    <p><strong>لینک:</strong> <br><small>${qrUrl}</small></p>
                    <button class="btn btn-success" onclick="downloadQR()">📥 ذخیره QR کد</button>
                    <button class="btn btn-warning" onclick="printQRSimple()">🖨️ چاپ QR کد</button>
                </div>
            `;
            
            updateStats();
        }

        function downloadQR() {
            const img = document.querySelector('#qrCode img');
            if (img) {
                const link = document.createElement('a');
                link.download = 'QR-Code-' + Date.now() + '.png';
                link.href = img.src;
                link.click();
            } else {
                alert('لطفاً اول QR کد تولید کنید');
            }
        }

        function printQRSimple() {
            const img = document.querySelector('#qrCode img');
            if (!img) {
                alert('لطفاً اول QR کد تولید کنید');
                return;
            }
            
            const originalContent = document.body.innerHTML;
            const originalTitle = document.title;
            
            document.body.innerHTML = `
                <div style="text-align: center; font-family: Tahoma; padding: 50px;">
                    <h1>فروشگاه ما</h1>
                    <h2>QR کد گردونه شانس</h2>
                    <img src="${img.src}" style="width: 300px; height: 300px; border: 3px solid #333;">
                    <p>این QR کد را اسکن کنید و در گردونه شانس شرکت کنید</p>
                    <p>تاریخ: ${new Date().toLocaleDateString('fa-IR')}</p>
                    <hr>
                    <small>هر QR کد فقط یکبار قابل استفاده است</small>
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            document.title = originalTitle;
            window.location.reload();
        }

        function updateStats() {
            const stats = qrManager.getStats();
            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('usedCount').textContent = stats.used;
        }

        window.onload = updateStats;
    </script>
</body>
    </html>
