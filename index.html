<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ø´Ø§Ù†Ø³</title>
    <style>
        body {
            font-family: Tahoma, sans-serif;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: #333;
        }
        .management-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        .btn:hover {
            background: #c0392b;
        }
        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .qr-container {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 10px;
        }
        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 20px auto;
        }
        .spin-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            margin: 20px 0;
        }
        .result {
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
        }
        .coupon {
            font-family: monospace;
            font-size: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px dashed #27ae60;
        }
        .error {
            background: #ffeaa7;
            color: #d63031;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .stats {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .tab {
            display: none;
        }
        .tab.active {
            display: block;
        }
        .btn-success {
            background: #27ae60;
        }
        .btn-success:hover {
            background: #219653;
        }
        .btn-info {
            background: #3498db;
        }
        .btn-info:hover {
            background: #2980b9;
        }
        .btn-warning {
            background: #f39c12;
        }
        .btn-warning:hover {
            background: #e67e22;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .print-section, .print-section * {
                visibility: visible;
            }
            .print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ØªØ¨â€ŒÙ‡Ø§ -->
        <div style="margin-bottom: 20px;">
            <button class="btn" onclick="showTab('management')">Ù…Ø¯ÛŒØ±ÛŒØª</button>
            <button class="btn" onclick="showTab('wheel')">Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ø´Ø§Ù†Ø³</button>
        </div>

        <!-- ØªØ¨ Ù…Ø¯ÛŒØ±ÛŒØª -->
        <div id="management" class="tab active">
            <h1>ğŸ¯ Ù…Ø¯ÛŒØ±ÛŒØª Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ø´Ø§Ù†Ø³</h1>
            <p>QR Ú©Ø¯ ÛŒÚ©Ø¨Ø§Ø± Ù…ØµØ±Ù Ø¨Ø±Ø§ÛŒ ØªØ±Ø§Ú©Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡</p>
            
            <div class="management-panel">
                <button class="btn" onclick="generateQR()">ØªÙˆÙ„ÛŒØ¯ QR Ú©Ø¯ Ø¬Ø¯ÛŒØ¯</button>
                
                <div class="qr-container">
                    <div id="qrCode"></div>
                    <div id="qrInfo"></div>
                </div>
                
                <div class="stats">
                    <h3>ğŸ“Š Ø¢Ù…Ø§Ø±</h3>
                    <p>ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡: <span id="totalCount">0</span></p>
                    <p>ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡: <span id="usedCount">0</span></p>
                </div>
            </div>
        </div>

        <!-- ØªØ¨ Ú¯Ø±Ø¯ÙˆÙ†Ù‡ -->
        <div id="wheel" class="tab">
            <h1>ğŸ¯ Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ø´Ø§Ù†Ø³ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</h1>
            <p>Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ØªØ®ÙÛŒÙ Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ø±Ùˆ Ø¨Ú†Ø±Ø®Ø§Ù†ÛŒØ¯!</p>
            
            <div class="wheel-container">
                <canvas id="wheelCanvas" width="300" height="300"></canvas>
            </div>
            
            <button class="spin-btn" id="spinBtn">Ú†Ø±Ø®Ø§Ù†Ø¯Ù† Ú¯Ø±Ø¯ÙˆÙ†Ù‡</button>
            
            <div class="result" id="result"></div>
            <div class="coupon" id="coupon" style="display: none;"></div>
            <div class="error" id="error" style="display: none;"></div>
        </div>
    </div>

    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>

    <script>
        // Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¨â€ŒÙ‡Ø§
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }

        // Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª QR Ú©Ø¯Ù‡Ø§
        class QRManager {
            constructor() {
                this.storageKey = 'wheelQRCodes';
                this.init();
            }

            init() {
                if (!localStorage.getItem(this.storageKey)) {
                    localStorage.setItem(this.storageKey, JSON.stringify({
                        qrcodes: {},
                        stats: { total: 0, used: 0 }
                    }));
                }
            }

            getData() {
                return JSON.parse(localStorage.getItem(this.storageKey));
            }

            saveData(data) {
                localStorage.setItem(this.storageKey, JSON.stringify(data));
            }

            generateQR() {
                const data = this.getData();
                const qrId = 'QR_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                
                data.qrcodes[qrId] = {
                    id: qrId,
                    used: false,
                    created: new Date().toLocaleString('fa-IR'),
                    usedAt: null,
                    discount: null,
                    couponCode: null
                };

                data.stats.total++;
                this.saveData(data);
                
                return qrId;
            }

            useQR(qrId, discount, couponCode) {
                const data = this.getData();
                if (data.qrcodes[qrId] && !data.qrcodes[qrId].used) {
                    data.qrcodes[qrId].used = true;
                    data.qrcodes[qrId].usedAt = new Date().toLocaleString('fa-IR');
                    data.qrcodes[qrId].discount = discount;
                    data.qrcodes[qrId].couponCode = couponCode;
                    
                    data.stats.used++;
                    this.saveData(data);
                    return true;
                }
                return false;
            }

            checkQR(qrId) {
                const data = this.getData();
                return data.qrcodes[qrId];
            }

            getStats() {
                return this.getData().stats;
            }
        }

        const qrManager = new QRManager();

        // Ø¨Ø®Ø´ Ù…Ø¯ÛŒØ±ÛŒØª
        function generateQR() {
            const qrId = qrManager.generateQR();
            const currentUrl = window.location.href.split('?')[0];
            const qrUrl = currentUrl + '?qr=' + qrId;
            
            document.getElementById('qrCode').innerHTML = '';
            
            QRCode.toCanvas(document.getElementById('qrCode'), qrUrl, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            });
            
            document.getElementById('qrInfo').innerHTML = `
                <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 5px;">
                    <p><strong>Ø´Ù†Ø§Ø³Ù‡:</strong> ${qrId}</p>
                    <p><strong>Ù„ÛŒÙ†Ú©:</strong> <br><small>${qrUrl}</small></p>
                    <button class="btn btn-success" onclick="downloadQR()">ğŸ“¥ Ø°Ø®ÛŒØ±Ù‡ QR Ú©Ø¯</button>
                    <button class="btn btn-warning" onclick="printQRSimple()">ğŸ–¨ï¸ Ú†Ø§Ù¾ QR Ú©Ø¯</button>
                </div>
            `;
            
            updateStats();
        }

        // Ø¯Ø§Ù†Ù„ÙˆØ¯ QR Ú©Ø¯
        function downloadQR() {
            const canvas = document.querySelector('#qrCode canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'QR-Code-' + Date.now() + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            } else {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§ÙˆÙ„ QR Ú©Ø¯ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯');
            }
        }

        // Ú†Ø§Ù¾ QR Ú©Ø¯ (Ø±ÙˆØ´ Û² - Ø¨Ø¯ÙˆÙ† popup)
        function printQRSimple() {
            const canvas = document.querySelector('#qrCode canvas');
            if (!canvas) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§ÙˆÙ„ QR Ú©Ø¯ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            const qrImage = canvas.toDataURL('image/png');
            
            // Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ
            const originalContent = document.body.innerHTML;
            const originalTitle = document.title;
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø­ØªÙˆØ§ÛŒ Ú†Ø§Ù¾
            document.body.innerHTML = `
                <div class="print-section" style="text-align: center; font-family: Tahoma; padding: 50px;">
                    <h1>ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ù…Ø§</h1>
                    <h2>QR Ú©Ø¯ Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ø´Ø§Ù†Ø³</h2>
                    <img src="${qrImage}" style="width: 300px; height: 300px; border: 3px solid #333;">
                    <p>Ø§ÛŒÙ† QR Ú©Ø¯ Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø± Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ø´Ø§Ù†Ø³ Ø´Ø±Ú©Øª Ú©Ù†ÛŒØ¯</p>
                    <p>ØªØ§Ø±ÛŒØ®: ${new Date().toLocaleDateString('fa-IR')}</p>
                    <hr>
                    <small>Ù‡Ø± QR Ú©Ø¯ ÙÙ‚Ø· ÛŒÚ©Ø¨Ø§Ø± Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª</small>
                </div>
            `;
            
            document.title = 'QR Ú©Ø¯ Ú¯Ø±Ø¯ÙˆÙ†Ù‡ Ø´Ø§Ù†Ø³';
            
            // Ú†Ø§Ù¾
            window.print();
            
            // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ
            document.body.innerHTML = originalContent;
            document.title = originalTitle;
            
            // Ø±ÙØ±Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ event listenerÙ‡Ø§
            window.location.reload();
        }

        function updateStats() {
            const stats = qrManager.getStats();
            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('usedCount').textContent = stats.used;
        }

        // Ø¨Ø®Ø´ Ú¯Ø±Ø¯ÙˆÙ†Ù‡
        class WheelGame {
            constructor() {
                this.canvas = document.getElementById('wheelCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.spinBtn = document.getElementById('spinBtn');
                this.resultDiv = document.getElementById('result');
                this.couponDiv = document.getElementById('coupon');
                this.errorDiv = document.getElementById('error');
                
                this.isSpinning = false;
                this.rotation = 0;
                this.segments = this.createSegments();
                
                this.init();
            }

            createSegments() {
                const segments = [];
                const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                
                for (let i = 1; i <= 100; i++) {
                    segments.push({
                        value: i,
                        text: i + '%',
                        color: colors[i % colors.length],
                        isReal: i <= 30
                    });
                }
                return segments;
            }

            init() {
                this.checkQR();
                this.drawWheel();
                this.spinBtn.addEventListener('click', () => this.spin());
            }

            getQRId() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('qr');
            }

            checkQR() {
                const qrId = this.getQRId();
                if (qrId) {
                    showTab('wheel');
                    const qrData = qrManager.checkQR(qrId);
                    
                    if (!qrData) {
                        this.showError('QR Ú©Ø¯ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª');
                        return;
                    }

                    if (qrData.used) {
                        this.showError('Ø§ÛŒÙ† QR Ú©Ø¯ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª');
                        this.spinBtn.disabled = true;
                    }
                }
            }

            showError(message) {
                this.errorDiv.style.display = 'block';
                this.errorDiv.textContent = 'âŒ ' + message;
                this.spinBtn.disabled = true;
            }

            drawWheel() {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const radius = this.canvas.width / 2 - 10;
                const segmentAngle = (2 * Math.PI) / this.segments.length;

                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                this.segments.forEach((segment, index) => {
                    const startAngle = index * segmentAngle + this.rotation;
                    const endAngle = (index + 1) * segmentAngle + this.rotation;

                    this.ctx.beginPath();
                    this.ctx.moveTo(centerX, centerY);
                    this.ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                    this.ctx.closePath();
                    this.ctx.fillStyle = segment.color;
                    this.ctx.fill();
                    this.ctx.stroke();

                    this.ctx.save();
                    this.ctx.translate(centerX, centerY);
                    this.ctx.rotate(startAngle + segmentAngle / 2);
                    this.ctx.textAlign = 'right';
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = 'bold 12px Tahoma';
                    
                    if (segment.value % 10 === 0 || segment.value <= 10) {
                        this.ctx.fillText(segment.text, radius - 15, 5);
                    }
                    
                    this.ctx.restore();
                });

                this.ctx.beginPath();
                this.ctx.arc(centerX, centerY, 15, 0, 2 * Math.PI);
                this.ctx.fillStyle = '#ffd700';
                this.ctx.fill();
                this.ctx.stroke();
            }

            async spin() {
                if (this.isSpinning) return;

                const qrId = this.getQRId();
                if (!qrId) {
                    this.showError('QR Ú©Ø¯ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª');
                    return;
                }

                this.isSpinning = true;
                this.spinBtn.disabled = true;
                this.resultDiv.textContent = '';
                this.couponDiv.style.display = 'none';

                const winningValue = Math.floor(Math.random() * 30) + 1;
                const targetRotation = this.rotation + (5 * 2 * Math.PI) + 
                                     ((winningValue - 1) * (2 * Math.PI / this.segments.length));

                await this.animateSpin(targetRotation);
                this.showResult(winningValue);
                this.saveResult(qrId, winningValue);
            }

            animateSpin(targetRotation) {
                return new Promise((resolve) => {
                    const startTime = Date.now();
                    const duration = 4000;

                    const animate = () => {
                        const currentTime = Date.now();
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        const easeOut = 1 - Math.pow(1 - progress, 3);
                        this.rotation = easeOut * targetRotation;
                        
                        this.drawWheel();

                        if (progress < 1) {
                            requestAnimationFrame(animate);
                        } else {
                            this.isSpinning = false;
                            resolve();
                        }
                    };

                    animate();
                });
            }

            showResult(discount) {
                const couponCode = 'DISC' + Date.now().toString(36).toUpperCase().substr(0, 8);
                
                this.resultDiv.textContent = `ğŸ‰ ØªØ¨Ø±ÛŒÚ©! Ø´Ù…Ø§ ${discount}% ØªØ®ÙÛŒÙ Ú¯Ø±ÙØªÛŒØ¯!`;
                this.resultDiv.style.background = '#d4edda';
                this.resultDiv.style.color = '#155724';
                
                this.couponDiv.style.display = 'block';
                this.couponDiv.textContent = `Ú©Ø¯ ØªØ®ÙÛŒÙ: ${couponCode}`;
                
                return couponCode;
            }

            saveResult(qrId, discount) {
                const couponCode = this.showResult(discount);
                qrManager.useQR(qrId, discount, couponCode);
                updateStats();
            }
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        const wheelGame = new WheelGame();
        window.onload = function() {
            updateStats();
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('qr')) {
                showTab('wheel');
            }
        };
    </script>
</body>
</html>
